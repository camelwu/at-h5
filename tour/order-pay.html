<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="green">
    <meta name="Keywords" content="亚洲旅行网">
    <meta name="Description" content="境外专业旅行服务提供机构">
    <meta name="screen-orientation" content="portrait">
    <meta name="x5-orientation" content="portrait">
    <meta name="full-screen" content="yes">
    <meta name="x5-fullscreen" content="true">
    <title>订单支付 - 亚洲旅行网</title>
    <link href="../styles/style.css" rel="stylesheet"/>
    <link href="../styles/framework.css" rel="stylesheet"/>
    <link href="../scenic/css/scenic.css" rel="stylesheet"/>
    <link href="../styles/tips.css"		rel="stylesheet" type="text/css">
    <link href="../css/user.css"	rel="stylesheet" type="text/css">
</head>
<body>
<div id="preloader">
    <div id="status-t">
        <p class="center-text">
            <br>
            <em>加载中……</em>
        </p>
    </div>
</div>
<div class="all-elements">

    <div class="header">
        <a href="javascript:history.go(-1);" class="header-back"><i class="icons go-back"></i></a>
        <h3>订单支付</h3>
        <i class="tel-icon"></i>
    </div>
    <div class="sc-content">
        <form action="#" method="get">
            <div class="per-pay-msg-bg">
                <!--<ul class="per-pay-msg">-->
                <!--<li>-->
                <!--<span>订单号: <i>237812</i></span>-->
                <!--</li>-->
                <!--<li>-->
                <!--<div>票务信息：<i>迪士尼门票1张；温泉门票1张</i></div>-->
                <!--<div class="pay-total">总价：<span style="color:#fe6a03">￥</span><i class="pay-num">143</i></div>-->
                <!--</li>-->
                <!--</ul>-->
            </div>
            <ul class="pay-style-list" id="pay_way">
                <li>剩余支付时间: <i class="count-time countdown" id="countdown" c></i></li>
                <li class="paymentType"><span class="jd-icon pay-card" data-type="pay-card"></span><span >银联支付</span><b class="icon circle-choi"></b></li>
                <!--<li><span class="jd-icon pay-bao"></span><b class="icon circle-chois"></b></li>-->
                <li class="paymentType"><span class="jd-icon pay-visa" data-type="pay-visa"></span><span >维萨信用卡支付</span><b class="icon circle-chois"></b></li>
                <li class="paymentType"><span class="jd-icon pay-master" data-type="pay-master"></span><span>万事达卡支付</span><b class="icon circle-chois"></b></li>
            </ul>
            <!--<div class="state-agree">-->
                <!--<b class="icon1 s-agree" id="agree"></b>-->
                <!--我已阅读并同意-->
                <!--<a href="#">购票须知</a>-->
            <!--</div>-->
            <a href="#" class="s-btn button-orange btnUpay">确认</a>
        </form>
    </div>
    <!--     国外支付方式浮层     -->
    <div id="out_pay" class="all-elements" style="display: none">
        <div class="header">
            <a id="close_page" class="header-back"><i class="icons go-back"></i></a>
            <h3 id="title">支付</h3>
            <b class="icons s-call"></b>
        </div>
        <!--     内容     -->
        <div class="sc-content" style="background-color: white">
            <div class="sp-total" id="order-price">
                <!--订单总价：￥<span>{%=chargeDetails[0].TotalAmount%}</span>-->
            </div>
            <ul class="fill-content">
                <li>
                    <div>持卡人姓名</div>
                    <input type="text" value placeholder="请输入持卡人姓名" class="CardHolderName">
                </li>
                <li>
                    <div>信用卡卡号</div>
                    <input type="number" value placeholder="请输入信用卡卡号" class="CardNumber">
                </li>
                <li>
                    <div>发卡银行</div>
                    <input type="text" value placeholder="发卡银行"  class="CardIssuanceBank">
                </li>
                <li class="countries-wrap">
                    <div>发卡国家</div>
                    <div><span class="country-btn CardCountryCode" data-code="CN" >中国</span><b class="icons s-xiala2"></b></div>
                    <!--<div>中国<b class="icons s-xiala2"></b></div>-->
                </li>
                <li>
                    <div>有效期</div>
                    <input type="number" value placeholder="月/年，如：09/12" class="CardExpiryDate">
                </li>
                <li>
                    <div>CVV2/CVC2号</div>
                    <input type="number" value placeholder="请输入签名栏末尾最后3位" class="CardSecurityCode">
                </li>
                <div class="fill-tel">
                    <div class="tel-div">持卡人手机号  <span>+86<b class="icons s-xiala1"></b></span></div>
                    <input type="tel" value placeholder="用于接收通知" class="PhoneNo">
                </div>
                <li>
                    <div>账单地址</div>
                    <input type="text" value placeholder="请输入持卡人账单地址" class="CardAddress" >
                </li>
                <li>
                    <div>账单城市</div>
                    <input type="text" value placeholder="请输入持卡人账单城市" class="CardAddressCity" >
                </li>

                <li>
                    <div>邮政编码</div>
                    <input type="number" value placeholder="请输入邮政编码" class="CardAddressPostalCode" >
                </li>
                <li class="countries-wrap">
                    <div>持卡人国家</div>
                    <div><span class="country-btn CardCountryCode CardIssuanceCountryCode" data-code="CN" >中国</span><b class="icons s-xiala2"></b></div>
                    <!--<div>中国<b class="icons s-xiala2"></b></div>-->
                </li>
            </ul>

            <a href="#" class="s-btn button-orange btnCpay">支付</a>
        </div>
    </div>
    !--国籍选择开始-->
    <div class="all-elements country-cho-wrap">
        <div class="header">
            <a href="javascript:;"  class="header-back country-hidden"><i class="icons go-back"></i></a>
            <div class="cl_search">
                <input type="text" placeholder="北京/beijing/bj/bjs/中国" id="country-input-zone"/>
                <i></i>
            </div>
        </div>

        <!--国籍弹窗开始-->
        <ul class="country-list-searched"></ul>
        <!--国籍弹窗结束-->

        <div class="snap-content" style="padding-top: 45px;">
            <div class="country-wrap" id="country-wrap">
                <!--<ul class="country-list">-->
                <!--<li></li>-->
                <!--</ul>-->
            </div>
        </div>
    </div>
    <!--国籍选择结束-->
    <script src="../js/lib/jquery.js"></script>
    <script src="../js/lib/jquery.alert.js"></script>
    <script src="../js/lib/vlm.js"></script>
    <script src="../js/lib/template.js"></script>
    <script src="../js/country_list.js"></script>
    <script>
        $(window).load(function () {
            Init();
        });
        var getCN = {
            "CNY": "￥",
            "SGD":"SGD",
            "USD":"$"
        };
        /*倒计时*/
        function sec(sName,time){
            var oSpan=document.getElementById(sName);
            var n=time;
            debugger;
            tick1();
            var timer=setInterval(tick1,1000);
            function tick1()
            {
                n--;
                var m=parseInt(n/60);
                var s=n%60;
                oSpan.innerHTML=toDub(m)+'分'+toDub(s)+'秒';
                if (n<0) {
                    clearInterval(timer);
                    oSpan.innerHTML="结束"
                }
            }
        }
        function toDub(a){
            return a<10 ? '0'+a : ''+a;
        }

        (function(){
            var bookingRefNo=vlm.getpara("bookingRefNo");
            var b=document.getElementById('pay_way').getElementsByTagName("b");
            var agree = $("#agree")[0];
            var close_page = $("#close_page")[0];
            var out_pay = $("#out_pay")[0];
            var btnPay= $(".btnUpay")[0];
            var btnCPay= $(".btnCpay")[0];

            $(".paymentType").click(function(){
                $(this).siblings().find("b").removeClass("circle-choi").addClass("circle-chois");
                $(this).find("b").removeClass("circle-chois").addClass("circle-choi");
            })

            close_page.onclick = function(){
                out_pay.style.display = "none";
            };
            btnPay.onclick=function(){
                var bookingRefNo=vlm.getpara("bookingRefNo");
                var type= $(".circle-choi").prev().attr("data-type");
                if(type=="pay-card") {
                    Payment("UnionPay",bookingRefNo)
                }
                else{
                    out_pay.style.display = "block";
                }
            }
            btnCPay.onclick=function(){
                Payment("CreditCard",bookingRefNo);
            }
        })();
        function Payment(type,code){

            var  Parameters=GetParameters(type,code);
            console.log(Parameters);
            if(Parameters) {
                vlm.loadJson("http://10.2.22.239:8888/api/GetServiceApiResult", JSON.stringify(Parameters), function (data) {
                    if (data.success) {
                        var url = data.data.paymentRedirectURL;
                        self.location.href=url;
                    } else {
                        alert(data.message);
                    }

                })
            }
        }

        function GetParameters(type,orderCode) {
            var json={}
            var Parameters = {};
            var PaymentDetails = {};
            var CardContactNumber={}
            Parameters.BookingRefNo = orderCode;
            Parameters.PaymentDetails=PaymentDetails;
            var CreditCardDetails = {};

            PaymentDetails.PayCurrencyCode="CNY";
            PaymentDetails.PayTotalAmount=$(".pay-num").html();
            debugger;


            if (type == "UnionPay")
            {
                PaymentDetails.PaymentMode="UnionPay";
            }
            else{
                if(!vlm.Utils.validate["isNoEmpty"]($(".CardHolderName").val())){
                    jAlert("持卡人姓名不能为空！","",null,"确认");
                    return false;
                }
                if(!vlm.Utils.validate["engName"]($(".CardHolderName").val())){
                    jAlert("持卡人姓名必须为英文！","",null,"确认");
                    return false;
                }

                if(!vlm.Utils.validate["isNoEmpty"]($(".CardNumber").val())){
                    jAlert("信用卡不能为空！","",null,"确认");
                    return false;
                }
                if(!vlm.Utils.validate["isNoEmpty"]($(".CardSecurityCode").val())){
                    jAlert("安全码不能为空！","",null,"确认");
                    return false;
                }
                if(!vlm.Utils.validate["isNoEmpty"]($(".CardExpiryDate").val())){
                    jAlert("有效期不能为空！","",null,"确认");
                    return false;
                }

                if(!vlm.Utils.validate["bankAccountNo"]($(".CardNumber").val())){
                    jAlert("信用卡卡号错误！","",null,"确认");
                    return false;
                }
                if(!vlm.Utils.validate["safecode"]($(".CardSecurityCode").val())){
                    jAlert("安全码3位数字！","",null,"确认");
                    return false;
                }
                if(!vlm.Utils.validate["dataValid"]($(".CardExpiryDate").val())){
                    jAlert("有效期格式不正确！","",null,"确认");
                    return false;
                }
                if(!vlm.Utils.validate["isNoEmpty"]($(".PhoneNo").val())){
                    jAlert("手机号不能为空！","",null,"确认");
                    return false;
                }
                if(!vlm.Utils.validate["isNoEmpty"]($(".CardCity").val())){
                    jAlert("账单城市不能不空！","",null,"确认");
                    return false;
                }
                if(!vlm.Utils.validate["isNoEmpty"]($(".CardAddress").val())){
                    jAlert("账单地址不能不空！","",null,"确认");
                    return false;
                }

                PaymentDetails.PaymentMode="CreditCard";
                PaymentDetails.ReturnURL="www.baidu.com";
                CreditCardDetails.CardType="Visa";
                CreditCardDetails.CardHolderName=$(".CardHolderName").val();
                CreditCardDetails.CardNumber=$(".CardNumber").val();
                CreditCardDetails.CardSecurityCode=$(".CardSecurityCode").val();
                CreditCardDetails.CardIssuanceBank=$(".CardIssuanceBank").val();
                CreditCardDetails.CardExpiryDate=$(".CardExpiryDate").val();
                CreditCardDetails.CardIssuanceCountryCode="SG"
                CreditCardDetails.CardAddress=$(".CardAddress").val();
                CreditCardDetails.CardAddressPostalCode=$(".CardAddressPostalCode").val();
                CreditCardDetails.CardAddressCity=$(".CardAddressCity").val();
                CreditCardDetails.CardAddressCountryCode= "SG",
                        CardContactNumber={};
                CardContactNumber.CountryCode="86";
                CardContactNumber.PhoneNo=$(".PhoneNo").val();
                CreditCardDetails.CardContactNumber=CardContactNumber;
                PaymentDetails.CreditCardDetails=CreditCardDetails
            }
            json.Parameters=Parameters;
            json.Method=null;
            json.ForeEndType=3;
            json.Code="0203";
            return json;
        }

        function Init(){
            var bookingRefNo=vlm.getpara("bookingRefNo");
            var Parameters={
                "Parameters": {
                    "BookingRefNo": bookingRefNo
                }
                ,
                "ForeEndType": 3,
                "Code": "0095"
            }
            vlm.loadJson("http://10.2.22.239:8888/api/GetServiceApiResult", JSON.stringify(Parameters), function(data){
                if(data.success) {
                    var date1=new Date();  //开始时间
                    var date2=new Date(data.data.bookingDate.replace("T"," "))
                    var date3=date1.getTime()-date2.getTime() //时间差的毫秒数
                    //计算出相差天数
                    var days=Math.floor(date3/(24*3600*1000))

                    //计算出小时数
                    var leave1=date3%(24*3600*1000)    //计算天数后剩余的毫秒数
                    var hours=Math.floor(leave1/(3600*1000))

                    //计算相差分钟数
                    var leave2=leave1%(3600*1000)        //计算小时数后剩余的毫秒数
                    var minutes=Math.floor(leave2/(60*1000))

                    //计算相差秒数
                    var leave3=leave2%(60*1000)      //计算分钟数后剩余的毫秒数
                    var seconds=Math.round(leave3/1000)


                    if(minutes*60+seconds<=30*60) {
                        sec('countdown',30*60-(minutes*60+seconds));
                    }
                    else{
                        $("#countdown").html("已经结束");

                    }
                    var sum = 0;

                    data.data.chargeDetails.forEach(function (item, index, array) {
                        sum += item.totalAmountInCNY;
                    });
                    data.data.totel=sum;

                    var tpl = template("tpl_orderinfo",data.data);
                    var tplC = template("tpl_orderTotal",data.data);
                    $(".per-pay-msg-bg").html(tpl);
                    $("#order-price").html(tplC);

                }
                else
                {
                    debugger;
                    jAlert("支付失败！");
                }
                vlm.init();

            });
        }
    </script>

    <!--机票-获取乘客信息-->
    <script id="tpl_orderinfo" type="text/template"	>
        <ul class="per-pay-msg">
            <li>
                <span>订单号: <i>{%=bookingRefNo%}</i></span>
            </li>
            <li>
                <div>票务信息：<i>{%=packageName%}</i></div>
                <div class="pay-total">总价：<span style="color:#fe6a03" class="totalAmount">￥</span><i class="pay-num">{%=totel%}</i></div>
            </li>
        </ul>
    </script>

    <script id="tpl_orderTotal" type="text/template"	>
         订单总价：￥<span>{%=totel%}</span>
    </script>

</div>
</body>
</html>