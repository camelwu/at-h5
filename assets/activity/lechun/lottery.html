<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,user-scalable=no">
  <title></title>
  <link rel="stylesheet" href="./less/lottery.css">
</head>
<body module-css-reset module-css-base>
<div class="mask hidden"></div>
<div class="alert hidden">
  <button class="close"></button>
  <p class="tips">恭喜你！<br>获得：&nbsp;<span class="prize_tips"></span></p>
  <p class="code">兑奖码：&nbsp;<span class="prize_code"></span></p>
  <p class="tips2">请牢记兑奖码才能成功领取奖品哦！</p>
  <button class="download"></button>
</div>
<img class="background" src="./img/background.jpg" alt="">
<div class="button_area">
  <button id="button" class="button" type="button"></button>
  <button class="button clicked hidden" type="button"></button>
</div>
<div class="lottery">
  <div class="stage">
    <div class="container">

    </div>
  </div>
  <div class="stage">
    <div class="container">

    </div>
  </div>
  <div class="stage">
    <div class="container">

    </div>
  </div>

  <div id="light" class="light light1"></div>
  <div class="light light1 hidden"></div>
  <div class="light light2 hidden"></div>
  <div class="rule_title">
    <p><a href="#activityRule">活动规则</a></p>
    <div class="line"></div>
  </div>
</div>
<div id="activityRule" class="activity_rule">
  <p>活动区域：全国</p>
  <p>活动时间：2016.08.08－ 2016.08.11</p>
  <p>领取方法：点击老虎机游戏按钮，摇中滚动中的图标，记录下中奖后生成的领取码。然后下载亚程旅游APP，打开APP在弹出的自动提示窗口中输入领取人信息和验证码。</p>
  <p>兑奖方式：小亚毛绒玩具、乐纯整箱酸奶将以快递的方式寄出；乐纯酸奶礼包券领取后可在“乐纯的伙伴们”酸奶微信公众号购买时直接使用。</p>
  <p>关注微信公共平台：亚程旅游 ID：atrip</p>
  <p>小亚客服微信ID：yanfei</p>
  <p>温馨提示：</p>
  <p>1、如果您半个小时内未提交领取信息，将视为自动放弃本次领取资格。</p>
  <p>2、同一部手机和手机号码只能领取一份奖品。</p>
  <p>3、本活动结束后7个工作日内，将陆续安排发放。</p>
  <p>4、本次活动不收取任何费用。</p>
</div>
<script src="../js/jquery/jquery.min.js"></script>
<script src="../js/vlm.js"></script>
<script>
  var container = document.querySelectorAll('.container');
  // 记录动画完成的全局变量，动画完成后置为true
  var AnimationEndStatus = true;


  // 初始化奖品界面
  !function initLottery() {
    // 默认展示金沙酒店、毛绒玩具、乐纯酸奶
    var initIndex = [0, 1, -2];
    Array.prototype.forEach.call(container, function (item, index) {
      // transformIndex是index位移
      var transformIndex = initIndex[index];
      transform(item, 'rotateX(' + (transformIndex * 72) + 'deg)');
      // 使用setTimeout，防止初始化时触发transition
      setTimeout(function () {
        transition(item, 'all ' + (index + 5) + 's');
      }, 200);
    });
  }()

  // 初始化转盘内容
  // hotel金沙酒店 gift红包 leben酸奶 cash购物券 doll亚程玩具
  var imgs = ['hotel', 'gift', 'lechun_leben', 'lechun_cash', 'doll'].map(function (item, index) {
    return '<img src="img/' + item + '.png">';
  }).join('');
  Array.prototype.forEach.call(container, function (item) {
    item.innerHTML = imgs;
  });

  // 切换屏幕上的灯
  var light = document.querySelector('#light');
  setInterval(function () {
    switchLight(light);
  }, 800);
  // 切换屏幕上的灯
  var switchLight = function (el) {
    if (el.classList.contains('light1')) {
      el.classList.remove('light1')
      el.classList.add('light2')
    } else if (el.classList.contains('light2')) {
      el.classList.remove('light2')
      el.classList.add('light1')
    }
  };


  // 按钮点击开始摇奖
  var i = 0;
  // doll亚程玩具 hotel金沙酒店 leben酸奶 cash购物券 gift红包
  document.querySelector('#button').addEventListener('click', function () {
    var _this = this;

    // 动画未完成，不可点击
    if (!AnimationEndStatus) {
      return;
    }
    // 点击后，按钮置为不可点
    AnimationEndStatus = false;

    /*sendAjaxObj({
      button: this,
      url: './mock/lottery.json',
      data: {
        "Parameters":{
          "DeviceID": "895623"
        },
        "ForeEndType": 3,
        "Code": "97100001"
      },
      type: 'GET',
      dataType: 'json',
      success: function (data) {
      },
      error: function (error) {

      },
      complete: function () {
      }
    })*/

    // testUrl: './mock/lottery.json', type: 'get'
    vlm.loadJson('', JSON.stringify({
      "Parameters": {
        "DeviceID": "895623"
      },
      "ForeEndType": 3,
      "Code": "97100001"
    }), function (data) {
      data = data.data;
      prizeCode = data.prizeCode;
      prizeType = data.prizeType;
      prizeTips = [null, '金沙酒店3晚住宿', '2.86元微信红包', '乐纯酸奶1箱', '乐纯酸奶25元代金券', '毛绒玩具小亚一只'];


      prizeTips = prizeTips[prizeType];

      // 摇奖开始，按钮置为不可点
      AnimationEndStatus = false;
      // 开始摇奖动画
      lotteryAnimation();
      // 切换按钮事件
      toggleClicked(_this);

      function lotteryAnimation() {
        i++;
        Array.prototype.forEach.call(container, function (item) {
          transform(item, 'rotateX(' + (-(prizeType - 1) * 72 + (-i) * 3600) + 'deg)')
        });
      }

      function toggleClicked(button) {
        button.classList.add('clicked');
        setTimeout(function () {
          button.classList.remove('clicked');
        }, 500);
      }
    });

  }, false);

  // 获取当前可用的transitionEnd事件名
  var transitionEvent = (function whichTransitionEvent() {
    var t, el = document.createElement('surface'), transitions = {
      'transition': 'transitionend',
      'OTransition': 'oTransitionEnd',
      'MozTransition': 'transitionend',
      'WebkitTransition': 'webkitTransitionEnd'
    }

    for (t in transitions) {
      if (el.style[t] !== undefined) {
        return transitions[t];
      }
    }
  })();

  var prizeCode, prizeTips;
  // 为每个animation添加animationEnd事件，animation都结束后弹出对话框
  var transitionFunc = function () {
    var i = 0;
    return function (item) {
      function transitionEndFunc() {
        i++;
        if (i === 3) {
          // 摇奖结束，按钮置为不可点
          AnimationEndStatus = true;

          // 弹出alert框
          $alert.bootstrap({
            prizeTips: prizeTips,
            prizeCode: prizeCode
          }).show()

          i = 0;
          /*Array.prototype.forEach.call(container, function (item2) {
            item2.removeEventListener(transitionEvent, transitionEndFunc, false);
          });*/
        }
      }

      item.addEventListener(transitionEvent, transitionEndFunc, false);
    }
  };
  var transitionFuncClosure = transitionFunc();
  Array.prototype.forEach.call(container, transitionFuncClosure);


  // 检测Android和iOS
  var userAgent = (function () {
    var userAgent = navigator.userAgent.toLowerCase();
    var isIOS = /iPhone|iPad|iPod/i.test(userAgent);
    var isAndroid = userAgent.indexOf('android') > 0;

    return {
      isIOS: isIOS,
      isAndroid: isAndroid
    }
  })();

  var $alert = (function () {
    var $alert = $('.alert');
    var $mask = $('.mask');
    var Alert = function (options) {
      this.initTips(options);
      this.bindEvent();
      return this;
    };
    Alert.prototype.initTips = function (options) {
      var prizeTips = options.prizeTips;
      var prizeCode = options.prizeCode;
      $alert.find('.prize_tips').text(prizeTips)
      $alert.find('.prize_code').text(prizeCode)
    }
    Alert.prototype.bindEvent = function () {
      var _this = this;
      $alert.find('.close').on('click', function () {
        _this.close();
      });
      $alert.find('.download').on('click', function () {
        if (userAgent.isAndroid) {
          location.href = 'http://url.cn/27QotxC';
        } else if (userAgent.isIOS) {
          location.href = 'http://m.yazhoulvyou.cn/';
        }
      });
    }
    Alert.prototype.show = function () {
      $alert.removeClass('hidden');
      $mask.removeClass('hidden');
    }
    Alert.prototype.hide = function () {
      $alert.addClass('hidden');
      $mask.addClass('hidden');
    }
    Alert.prototype.close = function () {
      this.hide();
    }
    Alert.prototype.openBrowserTips = function () {
    }

    Alert.prototype.unbindEvent = function () {
      $alert.find('.download').off('click');
      $alert.find('.close').off('click');
    }
    Alert.prototype.destroy = function () {
      // 解除绑定事件
      this.unbindEvent()
    }

    return {
      bootstrap: function (options) {
        return new Alert(options);
      }
    }
  })();


  // 以下是ajax函数
  function sendAjaxObj(options) {
    var button = options.button;
    if (button) {
      switchButtonDisabledStatus(true);
    }
    var args = {
      url: options.url,
      data: options.args,
      type: options.type || 'GET',
      dataType: 'json'
    };
    if (options.contentType) {
      args.contentType = options.contentType;
    }
    args.success = function (data) {
      if (data.code === 200) {
        options.success(data.data);
      } else {
        alert(data.message);
      }
    };
    args.error = function (error) {
      options.success(error);
    };
    args.complete = function () {
      if (button) {
        switchButtonDisabledStatus(false);
      }
      options.complete();
    };

    // 切换按钮的禁用状态，true不可点，false可点
    function switchButtonDisabledStatus(status) {
      if (typeof status === "boolean") {
        if (button instanceof Zepto) {
          button.prop('disabled', status);
        } else if (button.nodeType === 1) {
          button.disabled = status;
        }
        return true;
      } else {
        return false;
      }
    }

    return $.ajax(args);
  }

  // CSS transform变换应用
  function transform(element, value, key) {
    key = key || "Transform";
    ["Moz", "O", "Ms", "Webkit", ""].forEach(function (prefix) {
      element.style[prefix + key] = value;
    });

    return element;
  }
  function transition(element, value, key) {
    key = key || "Transition";
    ["Moz", "O", "Ms", "Webkit", ""].forEach(function (prefix) {
      element.style[prefix + key] = value;
    });

    return element;
  }

</script>
</body>
</html>