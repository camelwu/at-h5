<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="green">
    <meta name="Keywords" content="亚洲旅行网">
    <meta name="Description" content="境外专业旅行服务提供机构">
    <meta name="screen-orientation" content="portrait">
    <meta name="x5-orientation" content="portrait">
    <meta name="full-screen" content="yes">
    <meta name="x5-fullscreen" content="true">
    <title>订单支付 - 亚洲旅行网</title>
    <link href="../styles/style.css" rel="stylesheet"/>
    <link href="../styles/framework.css" rel="stylesheet"/>
    <link href="css/scenic.css" rel="stylesheet"/>
    <link href="../styles/tips.css"		rel="stylesheet" type="text/css">
    <link href="../css/user.css"	rel="stylesheet" type="text/css">
</head>
<body>
<div id="preloader">
    <div id="status">
        <p class="center-text">
            <br>
            <em>加载中……</em>
        </p>
    </div>
</div>
<div class="all-elements">
    <div class="header">
        <a href="javascript:history.go(-1);" class="icons header-back"></a>
        <h3>订单支付</h3>
    </div>
    <div class="sc-content">
        <form action="#" method="get">
            <div class="per-pay-msg-bg">
                <!--<ul class="per-pay-msg">-->
                    <!--<li>-->
                        <!--<span>订单号: <i>237812</i></span>-->
                    <!--</li>-->
                    <!--<li>-->
                        <!--<div>票务信息：<i>迪士尼门票1张；温泉门票1张</i></div>-->
                        <!--<div class="pay-total">总价：<span style="color:#fe6a03">￥</span><i class="pay-num">143</i></div>-->
                    <!--</li>-->
                <!--</ul>-->
            </div>
            <ul class="pay-style-list" id="pay_way">
                 <li>剩余支付时间: <i class="count-time" id="countdown"></i></li>
                 <li><span class="jd-icon pay-card"></span><b class="icon circle-choi"></b></li>
                 <!--<li><span class="jd-icon pay-bao"></span><b class="icon circle-chois"></b></li>-->
                <li><span class="jd-icon pay-visa"></span><b class="icon circle-chois"></b></li>
                <li><span class="jd-icon pay-master"></span><b class="icon circle-chois"></b></li>
            </ul>
            <div class="state-agree">
                <b class="icon1 s-agree" id="agree"></b>
                我已阅读并同意<a href="#">购票须知</a>
            </div>
            <a href="#" class="s-btn button-orange btnUpay">确认</a>
        </form>
    </div>
    <!--     国外支付方式浮层     -->
    <div id="out_pay" class="all-elements" style="display: none">
        <div class="header">
            <a id="close_page" class="icons header-back"></a>
            <h3 id="title">支付</h3>
            <b class="icons s-call"></b>
        </div>
        <!--     内容     -->
        <div class="sc-content" style="background-color: white">
            <div class="sp-total" id="order-price">
                <!--订单总价：￥<span>{%=chargeDetails[0].TotalAmount%}</span>-->
            </div>
            <ul class="fill-content">
                <li>
                    <div>持卡人姓名</div>
                    <input type="text" value placeholder="请输入持卡人姓名" class="CardHolderName">
                </li>
                <li>
                    <div>信用卡卡号</div>
                    <input type="text" value placeholder="请输入信用卡卡号" class="CardNumber">
                </li>
                <li>
                    <div>发卡银行</div>
                    <input type="text" value placeholder="发卡银行"  class="CardIssuanceBank">
                </li>
                <li>
                    <div>发卡国家</div>
                    <div><span class="country-btn CardCountryCode" data-code="CN" >中国</span><b class="icons s-xiala2"></b></div>
                    <!--<div>中国<b class="icons s-xiala2"></b></div>-->
                </li>
                <li>
                    <div>有效期</div>
                    <input type="text" value placeholder="月/年，如：09/12" class="CardExpiryDate">
                </li>
                <li>
                    <div>CVV2/CVC2号</div>
                    <input type="text" value placeholder="请输入签名栏末尾最后3位" class="CardSecurityCode">
                </li>
                <div class="fill-tel">
                    <div class="tel-div">持卡人手机号  <span>+86<b class="icons s-xiala1"></b></span></div>
                    <input type="text" value placeholder="用于接收通知" class="PhoneNo">
                </div>
                <li>
                    <div>账单地址</div>
                    <input type="text" value placeholder="请输入持卡人账单地址" class="CardAddress" >
                </li>
                <li>
                    <div>账单城市</div>
                    <input type="text" value placeholder="请输入持卡人账单城市" class="CardAddressCity" >
                </li>


                <li>
                    <div>邮政编码</div>
                    <input type="text" value placeholder="请输入邮政编码" class="CardAddressPostalCode" >
                </li>
                <li>
                    <div>持卡人国家</div>
                    <div><span class="country-btn CardCountryCode CardIssuanceCountryCode" data-code="CN" >中国</span><b class="icons s-xiala2"></b></div>
                    <!--<div>中国<b class="icons s-xiala2"></b></div>-->
                </li>
            </ul>

            <a href="#" class="s-btn button-orange btnCpay">支付</a>
        </div>
    </div>
    !--国籍选择开始-->
    <div class="all-elements country-cho-wrap">
        <div class="header">
            <a href="javascript:;" class="icons header-back country-hidden"></a>
            <div class="cl_search">
                <input type="text" placeholder="北京/beijing/bj/bjs/中国" id="country-input-zone"/>
                <i></i>
            </div>
        </div>

        <!--国籍弹窗开始-->
        <ul class="country-list-searched"></ul>
        <!--国籍弹窗结束-->

        <div class="snap-content" style="padding-top: 45px;">
            <div class="country-wrap" id="country-wrap">
                <!--<ul class="country-list">-->
                <!--<li></li>-->
                <!--</ul>-->
            </div>
        </div>
    </div>
    <!--国籍选择结束-->
    <script src="../js/lib/jquery.js"></script>
    <script src="../js/lib/jquery.alert.js"></script>
    <script src="../js/lib/vlm.js"></script>
    <script src="../js/lib/template.js"></script>
    <script src="js/order-pay.js"></script>
    <script src="../js/country_list.js"></script>
<script>
    var getCN = {
        "CNY": "￥",
        "SGD":"SGD",
        "USD":"$"
    };

    function sec(sName,time){
        var oSpan=document.getElementById(sName);
        var n=time;
        tick1();
        var timer=setInterval(tick1,1000);
        function tick1()
        {
            n--;
            var m=parseInt(n/60);
            var s=n%60;
            oSpan.innerHTML=toDub(m)+'分'+toDub(s)+'秒';
            if (n<0) {
                clearInterval(timer);
                oSpan.innerHTML="结束"
            }
        }
    }
    function toDub(a){
        return a<10 ? '0'+a : ''+a;
    }

    (function(){
        Init();
        var b=document.getElementById('pay_way').getElementsByTagName("b");
        var agree = $("#agree")[0];
        var close_page = $("#close_page")[0];
        var out_pay = $("#out_pay")[0];
        var btnPay= $(".btnUpay")[0];
        var btnCPay= $(".btnCpay")[0];
        for(var i=0; i < b.length; i++){
            b[i].onclick = function(){
                for(var i=0; i<b.length; i++){
                    b[i].className = "icon circle-chois";
                }
                this.className='icon circle-choi';
                if(b[1].className == "icon circle-choi"||b[2].className == "icon circle-choi"){
                    out_pay.style.display = "block";
                }
                else{
                    Payment("UnionPay","SG17SINFP0375501");
                }
            }
        }
        agree.onclick = function(){
            if(agree.className == 'icon1 s-agree'){
                agree.className = 'icon1 s-agrees';
            }else{
                agree.className = 'icon1 s-agree';
            }
        };
        close_page.onclick = function(){
            out_pay.style.display = "none";
        };
        btnPay.onclick=function(){
            var bookinbgRefNo=vlm.getpara("BookingRefNo");
            Payment("UnionPay",bokinbgRefNo);
        }
        btnCPay.onclick=function(){
            var bookinbgRefNo=vlm.getpara("BookingRefNo");
            Payment("CreditCard",bookinbgRefNo);
        }
    })();
    function Payment(type,code){

       var  Parameters=GetParameters(type,code);
        if(Parameters) {
            console.log(Parameters);
            vlm.loadJson("http://10.2.22.239:8888/api/GetServiceApiResult", JSON.stringify(Parameters), function (data) {
                var data = JSON.parse(data);
                if (data.success) {
                    var url = data.data.paymentRedirectURL;
                    window.open(url);
                } else {
                    alert(data.message);
                }
                vlm.init();

            })
        }
    }
    function GetParameters(type,orderCode) {
        var json={}
        var Parameters = {};
        var PaymentDetails = {};
        var CardContactNumber={}
        Parameters.BookingRefNo = orderCode;
        Parameters.PaymentDetails=PaymentDetails;
        var CreditCardDetails = {};

        PaymentDetails.PayCurrencyCode="CNY";
        PaymentDetails.PayTotalAmount=$(".totalAmount").html();

        if(!vlm.Utils.validate["isNoEmpty"]($(".CardHolderName").val())){
            jAlert("持卡人姓名不能为空！","",null,"确认");
            return false;
        }
        if(!vlm.Utils.validate["engName"]($(".CardHolderName").val())){
            jAlert("持卡人姓名必须为英文！","",null,"确认");
            return false;
        }

        if(!vlm.Utils.validate["isNoEmpty"]($(".CardNumber").val())){
            jAlert("信用卡不能为空！","",null,"确认");
            return false;
        }
        if(!vlm.Utils.validate["isNoEmpty"]($(".CardSecurityCode").val())){
            jAlert("安全码不能为空！","",null,"确认");
            return false;
        }
        if(!vlm.Utils.validate["isNoEmpty"]($(".CardExpiryDate").val())){
            jAlert("有效期不能为空！","",null,"确认");
            return false;
        }

        if(!vlm.Utils.validate["bankAccountNo"]($(".CardNumber").val())){
            jAlert("信用卡卡号错误！","",null,"确认");
            return false;
        }
        if(!vlm.Utils.validate["safecode"]($(".CardSecurityCode").val())){
            jAlert("安全码3位数字！","",null,"确认");
            return false;
        }
        if(!vlm.Utils.validate["dataValid"]($(".CardExpiryDate").val())){
            jAlert("有效期格式不正确！","",null,"确认");
            return false;
        }
        if(!vlm.Utils.validate["isNoEmpty"]($(".PhoneNo").val())){
            jAlert("手机号不能为空！","",null,"确认");
            return false;
        }
        if(!vlm.Utils.validate["isNoEmpty"]($(".CardCity").val())){
            jAlert("账单城市不能不空！","",null,"确认");
            return false;
        }
        if(!vlm.Utils.validate["isNoEmpty"]($(".CardAddress").val())){
            jAlert("账单地址不能不空！","",null,"确认");
            return false;
        }

        if (type == "UnionPay")
        {
            PaymentDetails.PaymentMode="UnionPay";
        }
        else{
            PaymentDetails.PaymentMode="CreditCard";
            PaymentDetails.ReturnURL="www.baidu.com";
            CreditCardDetails.CardType="Visa";
            CreditCardDetails.CardHolderName=$(".CardHolderName").val();
            CreditCardDetails.CardNumber=$(".CardNumber").val();
            CreditCardDetails.CardSecurityCode=$(".CardSecurityCode").val();
            CreditCardDetails.CardIssuanceBank=$(".CardIssuanceBank").val();
            CreditCardDetails.CardExpiryDate=$(".CardExpiryDate").val();
            CreditCardDetails.CardIssuanceCountryCode="SG"
            CreditCardDetails.CardAddress=$(".CardAddress").val();
            CreditCardDetails.CardAddressPostalCode=$(".CardAddressPostalCode").val();
            CreditCardDetails.CardAddressCity=$(".CardAddressCity").val();
            CreditCardDetails.CardAddressCountryCode= "SG",
            CardContactNumber={};
            CardContactNumber.CountryCode="86";
            CardContactNumber.PhoneNo=$(".PhoneNo").val();
            CreditCardDetails.CardContactNumber=CardContactNumber;
            PaymentDetails.CreditCardDetails=CreditCardDetails
        }
        json.Parameters=Parameters;
        json.ForeEndType=3;
        json.Code="0093";
        return json;
    }

    function Init(){
        var bookinbgRefNo=vlm.getpara("BookingRefNo");
        if(bookinbgRefNo==null){
            jAlert("参数订单BookingRefNo不能为空！");
            return;
        }
        var Parameters={
            "Parameters": {
                "BookingRefNo": bookinbgRefNo
            },
            "ForeEndType": 3,
            "Code": "0095"
        }
        vlm.loadJson("http://10.2.22.239:8888/api/GetServiceApiResult", JSON.stringify(Parameters), function(data){
            var data=JSON.parse(data);
            if(data.success) {
                debugger;
                var date1=new Date();  //开始时间
                var date2=new Date(data.data.bookingDate.replace("T"," "))
                var date3=date1.getTime()-date2.getTime() //时间差的毫秒数
                //计算出相差天数
                var days=Math.floor(date3/(24*3600*1000))

                //计算出小时数
                var leave1=date3%(24*3600*1000)    //计算天数后剩余的毫秒数
                var hours=Math.floor(leave1/(3600*1000))

                //计算相差分钟数
                var leave2=leave1%(3600*1000)        //计算小时数后剩余的毫秒数
                var minutes=Math.floor(leave2/(60*1000))

                //计算相差秒数
                var leave3=leave2%(60*1000)      //计算分钟数后剩余的毫秒数
                var seconds=Math.round(leave3/1000)


                if(days==0 && hours==0 && minutes*60+seconds<=30*60) {
                    sec('countdown',30*60-(minutes*60+seconds));
                }
                else{
                    var oSpan=document.getElementById("countdown")
                    $("#countdown").html("已经结束");
                }
                var tpl = template("tpl_orderinfo",data.data);
                var tplC = template("tpl_orderTotal",data.data);
                $(".per-pay-msg-bg").html(tpl);
                $("#order-price").html(tplC);

            }
            else {
                alert("网络异常，加载失败！");
            }
            vlm.init();

        });
    }
</script>

    <!--机票-获取乘客信息-->
    <script id="tpl_orderinfo" type="text/template"	>
        <ul class="per-pay-msg">
            <li>
                <span>订单号: <i>{%=bookingRefNo%}</i></span>
            </li>
            <li>
                <div>票务信息：<i> {%=packageName%}{%=travelers.length%}张</i></div>
                <div class="pay-total">总价：<span style="color:#fe6a03" class="totalAmount">{%=chargeDetails[0].totalAmount%}</span><i class="pay-num">{% var d=chargeDetails[0]; %}{%=getCN[d.currencyCode]%}</i></div>
            </li>
        </ul>
    </script>

    <script id="tpl_orderTotal" type="text/template"	>
        订单总价：{% var d=chargeDetails[0]; %} {%=getCN[d.currencyCode]%}<span>{%=chargeDetails[0].totalAmount%}</span>
    </script>

</div>
</body>
</html>